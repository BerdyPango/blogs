---
title: 《实现领域驱动设计》读书笔记(7) - 战术建模之领域事件
date: 2017-03-14 01:22:31
description: 
categories:
- 架构与模式
- DDD
tags: 
- ddd
- note
---

# 建模领域事件
在建模领域事件时，我们应该根据限界上下文中的通用语言来命名事件及其属性。如果事件由聚合上的**「命令」**操作产生，那么我们通常根据该操作方法的名字来命名领域事件。事件的名字表明了聚合上的命令方法在执行成功**之后**所发生的事情，例如 BacklogItemComiited

> 事件的名字应该反映过去发生的事情。

有了正确的事件名之后，我们需要定义一个时间戳来表示事件发生的时间。接下来，考虑一下是谁触发了该事件，这通常包括产生该领域事件的聚合和其他参与操作的聚合，也有可能是其他任何类型的数据属性。例如: 
{%codeblock lang:csharp%}
public class BacklogItemCommitted: DomainEvent{
    private Datetime _occurredOn;
    private BacklogItemId _backlogItemId;
    private SprintId _committedToSprintId;
    private TenantId _tenantId;
}
{%endcodeblock%}
`BacklogItem` 是事件的发起方，`Sprint` 是事件的参与方，当 `BacklogItem` 被提交到 `Sprint` 之后，该 `Sprint` 应该收到通知。因此，事件订阅方通过该事件的 `SprintId` 查询出应该通知哪一个 `Sprint`。

> 领域事件通常被设计成**「不变的」**，并且通过构造函数接收全部必须参数来初始化状态。

# 创建具有聚合特征的领域事件
如果领域事件不由聚合中的命令方法产生，而是直接由客户方所发出的请求产生。此时领域事件可以建模成一个聚合，并且可以拥有自己的资源库。但是，由于领域事件代表过去发生的事情，因此资源库是不能对事件进行删除的。由这种方式所创建的事件应该成为模型结构的一部分，此时的领域事件依然应该设计成**「不变的」**，但它们拥有唯一标识。

客户方可通过领域服务来创建事件，然后将其添加到资源库中，再通过消息设施(例如消息中间件)进行发布。此时，资源库和消息设施必须使用相同的持久化实例(数据源)或全局事务来保证对事件的成功提交。

## 身份标识
在创建，发布事件的限界上下文中，我们几乎没有理由对不同事件进行比较。当需要将领域事件发布到外部限界上下文中时，创建身份标识是有必要的。单条消息可能会被多次分发，不管是什么原因导致了对消息的重新发布，消息订阅方都需要检查出重复的消息，并将其忽略掉。

只有当事件用于本地限界上下文时，才为领域事件提供 Equals() 和 GetHashCode() 方法实现。对于通过消息设施发生的事件，有时订阅方接收的并不是事件对象本身。

# 从领域模型中发布领域事件